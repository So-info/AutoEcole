<!DOCTYPE html>
<html lang="fr" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />

  <title>Auto √âcole Nounours ‚Äì Entra√Ænement Permis Moto</title>
  <meta property="og:title" content="Auto √âcole Nounours ‚Äì Entra√Ænement Permis Moto">
  <meta property="og:description" content="Entra√Ænez-vous au code moto avec Auto √âcole Nounours : s√©ries personnalis√©es, filtres par th√®mes et sauvegarde automatique.">

<style>
  :root{
    --bg:#0b1220; --bg-soft:#0e1628; --card:#0f192e; --card-2:#0e172a; --text:#e5e7eb; --muted:#9ca3af; --line:rgba(255,255,255,.08);
    --accent:#22d3ee; --accent-2:#60a5fa; --success:#34d399; --warning:#fbbf24; --danger:#f87171;
    --brand:#f59e0b; --brand-2:#f97316; --accent:var(--brand); --accent-2:var(--brand-2);
    --ring:0 0 0 2px color-mix(in oklab, var(--accent) 45%, transparent);
  }
  :root[data-theme="light"]{
    --bg:#f6f8fc; --bg-soft:#edf1f7; --card:#ffffff; --card-2:#f7fafc; --text:#0b1220; --muted:#586174; --line:rgba(0,0,0,.08);
    --accent:#0ea5e9; --accent-2:#6366f1
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;color:var(--text);
    background:
      radial-gradient(1200px 800px at 70% -10%, color-mix(in oklab, var(--bg) 80%, #172036) 0%, transparent 40%),
      radial-gradient(900px 600px at -10% 120%, color-mix(in oklab, var(--bg) 90%, #0b1220) 0%, transparent 50%),
      linear-gradient(180deg, var(--bg) 0%, var(--bg-soft) 100%);
    -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility
  }
  .container{max-width:1000px;margin:0 auto;padding:16px}

  header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
  .title{font-size:clamp(22px,5vw,34px);font-weight:800;letter-spacing:.2px}
  .subtitle{color:var(--muted);font-size:14px}

  /* Tabs */
  .tabs{display:flex;gap:8px;align-items:center;margin:8px 0 16px;border-bottom:1px solid var(--line)}
  .tab{
    appearance:none;background:transparent;border:none;color:var(--muted);
    font-weight:800;letter-spacing:.2px;padding:10px 14px;border-radius:10px 10px 0 0;cursor:pointer;
    transition:color .15s ease, background .15s ease
  }
  .tab:hover{color:var(--text)}
  .tab[aria-selected="true"]{
    color:var(--text);
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.015));
    border:1px solid var(--line);border-bottom-color:transparent
  }

  /* Cards */
  .card{
    background:
      linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.02)),
      linear-gradient(180deg, var(--card), var(--card-2));
    border:1px solid var(--line);border-radius:18px;
    box-shadow:0 8px 30px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.02);
    overflow:hidden
  }
  .panel{padding:16px}

  /* Toolbars */
  .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  /* centrage du CTA de l‚Äôexamen blanc */
  #card-exam .toolbar{justify-content:center}

  /* Boutons modernis√©s */
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:10px;cursor:pointer;
    min-height:44px;padding:12px 16px;font-weight:800;letter-spacing:.2px;border-radius:14px;
    border:1px solid var(--line);
    background:linear-gradient(180deg, color-mix(in oklab, var(--card) 85%, transparent),
                                      color-mix(in oklab, var(--card-2) 85%, transparent));
    color:var(--text);
    box-shadow:0 6px 24px rgba(0,0,0,.16), inset 0 1px 0 rgba(255,255,255,.06);
    transition: transform .15s ease, box-shadow .15s ease, background .15s ease, opacity .15s ease
  }
  :root[data-theme="light"] .btn{background:linear-gradient(180deg,#f7fafc,#eef2f7);color:#0b1220}
  .btn:hover{transform:translateY(-1px);box-shadow:0 10px 28px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.08)}
  .btn:active{transform:translateY(0) scale(.98)}
  .btn:focus-visible{outline:none;box-shadow: var(--ring), 0 0 0 1px color-mix(in oklab, var(--accent) 60%, transparent)}
  .btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}

  /* Variantes */
  .btn-primary{
    border-color: color-mix(in oklab, var(--accent) 45%, transparent);
    background:linear-gradient(180deg, color-mix(in oklab, var(--accent) 60%, transparent),
                                      color-mix(in oklab, var(--accent-2) 45%, transparent));
  }
  .btn-outline{background:transparent;border-color: color-mix(in oklab, var(--accent) 40%, transparent)}
  .btn-ghost{background:transparent;border-color: var(--line);box-shadow: inset 0 1px 0 rgba(255,255,255,.04)}
  .btn-lg{min-height:52px;padding:14px 20px;font-size:16px;border-radius:16px}
  .btn-sm{min-height:36px;padding:8px 12px;font-size:13px;border-radius:12px}
  .btn-toggle{display:inline-flex;align-items:center;gap:8px}

  /* Groupes */
  .btn-group{display:flex;gap:10px;flex-wrap:wrap}
  .btn-group .btn{flex:0 0 auto}

  /* Question */
  .question-header{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
  .q-index{font-weight:800;letter-spacing:.5px;color:var(--accent)}
  .chip{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:rgba(255,255,255,.03);font-size:13px;color:var(--muted)}
  :root[data-theme="light"] .chip{background:#f7fafc}

  /* R√©ponses */
  .answers{display:grid;gap:10px;margin-top:12px}
  .answer{
    position:relative;display:flex;gap:12px;align-items:center;
    padding:14px 14px 14px 46px;border-radius:14px;border:1px solid var(--line);
    background:rgba(255,255,255,.02);min-height:52px;
    transition:.12s border-color,.12s background,.12s transform
  }
  :root[data-theme="light"] .answer{background:#fff}
  .answer:hover{border-color:rgba(255,255,255,.16);background:rgba(255,255,255,.04)}
  :root[data-theme="light"] .answer:hover{background:#f8fafc}
  .answer input{position:absolute;left:14px;width:22px;height:22px;margin:0;appearance:none;outline:none;border-radius:50%}
  .answer input[type="checkbox"]{border-radius:6px}
  .answer input::before{content:"";display:block;width:22px;height:22px;border-radius:inherit;border:2px solid color-mix(in oklab, var(--accent) 75%, #93c5fd 25%);box-shadow: inset 0 0 0 2px transparent}
  .answer input:checked::before{background:linear-gradient(180deg, var(--accent), var(--accent-2));border-color:transparent;box-shadow: inset 0 0 0 2px rgba(0,0,0,.2)}
  .answer:has(input:focus-visible){box-shadow:var(--ring)}
  .answer.is-correct{border-color:rgba(52,211,153,.6)!important;background:rgba(52,211,153,.12)!important}
  .answer.is-wrong{border-color:rgba(248,113,113,.6)!important;background:rgba(248,113,113,.10)!important}

  .explanation{font-size:14px;color:var(--muted);border-left:3px solid rgba(34,211,238,.4);padding-left:12px}

  /* Footer */
  .footer-sticky{
    position:sticky;bottom:0;z-index:2;
    background:linear-gradient(180deg, color-mix(in oklab, var(--bg) 40%, transparent), var(--bg));
    backdrop-filter:blur(6px);border-top:1px solid var(--line);padding:10px;border-radius:14px
  }
  .footer{display:flex;align-items:center;gap:12px}
  .footer-progress{flex:1;display:grid;gap:6px}
  .progress-wrap{position:relative;height:10px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
  :root[data-theme="light"] .progress-wrap{background:#e5e7eb}
  .progress{position:absolute;inset:0;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2))}
  .pill{font-size:12px;color:var(--muted)}

  /* Filtres & r√©sultats */
  .filters{display:grid;gap:8px}
  .filters .row{display:flex;flex-wrap:wrap;gap:8px}
  .tag{padding:6px 10px;border:1px dashed var(--line);border-radius:999px;background:rgba(255,255,255,.03);font-size:13px}
  :root[data-theme="light"] .tag{background:#f7fafc}
  .result{display:grid;gap:14px;text-align:center;padding:22px;background:radial-gradient(800px 400px at 0% 0%,rgba(34,211,238,.08),rgba(255,255,255,0))}
  .score{font-size:clamp(34px,7vw,60px);font-weight:900;letter-spacing:-.5px}
  .score.good{color:var(--success)} .score.mid{color:var(--warning)} .score.bad{color:var(--danger)}
  .review{display:grid;gap:12px;margin-top:12px}
  .review-item{border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(255,255,255,.02);box-shadow:inset 0 1px 0 rgba(255,255,255,.02)}
  :root[data-theme="light"] .review-item{background:#fff}
  .review-item .status{font-weight:700}
  .ok{color:var(--success)} .ko{color:var(--danger)}
  details summary{cursor:pointer}

  /* Responsive tweaks */
  @media (max-width:520px){
    .toolbar .btn{flex:1 1 100%}
    .footer .toolbar{width:100%}
    .footer .toolbar .btn{flex:1 1 auto;min-width:0}
  }
  @media (max-width:380px){
    .panel{padding:12px}
    .answer{padding:12px 12px 12px 44px}
    .answer input{left:12px}
    .btn{padding:10px 12px;border-radius:10px}
  }
  @media (prefers-reduced-motion:reduce){ *{transition:none!important;animation:none!important} }
</style>

</head>
<body>
  <div class="container">
    <header>
      <div>
        <div class="title">Auto √âcole Nounours ‚Äì Entra√Ænement Permis Moto</div>
        <div class="subtitle" id="subtitle">S√©rie d'entra√Ænement g√©n√©r√©e al√©atoirement.</div>
      </div>
      <div class="toolbar btn-group" aria-label="Actions g√©n√©rales">
        <button id="btn-new" class="btn btn-primary">Nouvelle s√©rie</button>
        <button id="btn-reset" class="btn btn-ghost">R√©initialiser</button>
        <button id="btn-export" class="btn">Exporter (JSON)</button>
        <button id="btn-theme" class="btn btn-toggle" title="Basculer le th√®me">üåì Th√®me</button>
      </div>
    </header>

    <nav class="tabs" role="tablist" aria-label="Navigation">
      <button id="tabbtn-quiz" class="tab" role="tab" aria-selected="true" aria-controls="panel-quiz">Quiz</button>
      <button id="tabbtn-settings" class="tab" role="tab" aria-selected="false" aria-controls="panel-settings">Param√®tres & Infos</button>
    </nav>
    <!-- Examen blanc card (NOUVEAU) -->
    <section id="card-exam" class="card" aria-label="Examen blanc" style="margin-bottom:12px">
      <div class="panel">
        <h2 style="margin:0">Examen blanc ‚Äì 40 questions</h2>
        <p class="subtitle" style="margin:6px 0 12px">
          R√©pondez aux 40 questions. Les r√©sultats ne s‚Äôaffichent qu‚Äô√† la fin.
        </p>
        <div class="toolbar">
        <button id="btn-start-exam" class="btn btn-primary btn-lg">Commencer l'examen blanc</button>
        <button id="btn-exit-exam" class="btn btn-outline" style="display:none">Quitter le mode examen</button>
        </div>
        <div class="chip" id="exam-hint" style="display:none"></div>
      </div>
    </section>

    <!-- Quiz panel -->
    <section id="panel-quiz" role="tabpanel" aria-labelledby="tabbtn-quiz">
      <div class="card" aria-labelledby="q-index">
        <div class="panel">
          <div class="question-header">
            <div>
              <div class="q-index" id="q-index">Question 1</div>
              <h1 id="q-text" style="margin:6px 0 0 0; font-weight:800;font-size:20px"></h1>
              <div class="pill" id="q-meta"></div>
            </div>
            <div class="chip" id="timer" aria-live="polite">Temps: 00:00</div>
          </div>
          <div class="answers" id="answers" role="group" aria-labelledby="q-text"></div>
          <details id="exp-wrap" style="margin-top:10px; display:none;">
            <summary>Voir l'explication</summary>
            <p class="explanation" id="explanation"></p>
          </details>
        </div>
        <div class="footer-sticky">
          <div class="footer">
            <div class="toolbar" style="flex:0 0 auto">
              <button id="btn-prev" class="btn" disabled>Pr√©c√©dent</button>
              <button id="btn-next" class="btn btn-primary btn-lg">Suivant</button>
              <button id="btn-check" class="btn btn-lg">V√©rifier</button>
            </div>
            <div class="footer-progress">
              <div class="progress-wrap" aria-hidden="true"><div class="progress" id="progress"></div></div>
              <div class="pill" id="status" aria-live="polite">0 correct ¬∑ 0 faux</div>
            </div>
          </div>
        </div>
      </div>

      <!-- R√©sultats (d√©sormais dans l'onglet Quiz) -->
      <section id="card-result" class="card" style="display:none; margin-top:12px">
        <div class="panel">
          <div class="result" id="result" style="display:none">
            <div id="score" class="score">0 / 0</div>
            <div class="subtitle" id="score-note">‚Äî</div>
            <div class="toolbar" style="justify-content:center">
              <button id="btn-review" class="btn btn-primary">Revoir mes r√©ponses</button>
              <button id="btn-retry-wrong" class="btn">Rejouer mes erreurs</button>
            </div>
          </div>
          <div id="review" class="review" style="display:none"></div>
        </div>
      </section>
    </section>

    <!-- Settings panel -->
    <section id="panel-settings" role="tabpanel" aria-labelledby="tabbtn-settings" hidden>
      <aside class="card" aria-label="Param√®tres et r√©sultats">
        <div class="panel">
          <h2 style="margin-top:0">Param√®tres & Infos</h2>
          <div class="chip">Mode: QCM (1 bonne r√©ponse sauf mention contraire)</div>
          <div style="height:10px"></div>
          <div class="filters">
            <strong>Filtres de g√©n√©ration</strong>
            <div class="row" id="themes"></div>
            <div class="row" id="levels"></div>
            <div class="row">
              <label class="chip"><input id="count" type="number" min="1" step="1" value="40" style="width:80px;margin-right:8px"> nb questions</label>
              <button id="btn-apply-filters" class="btn">G√©n√©rer avec filtres</button>
              <span class="tag" id="filtered-size">Pool filtr√©: ‚Ä¶</span>
            </div>
          </div>
          <div style="height:10px"></div>
          <label class="chip"><input id="toggle-instant" type="checkbox" style="margin-right:8px"> Correction imm√©diate</label>
          <label class="chip"><input id="toggle-explanations" type="checkbox" checked style="margin-right:8px"> Afficher l'explication apr√®s correction</label>
          <label class="chip"><input id="toggle-shuffle-answers" type="checkbox" checked style="margin-right:8px"> M√©langer les propositions</label>
          <div style="height:10px"></div>
          <div class="chip" id="pool-size">Banque de questions: ‚Ä¶</div>
          <div class="chip" id="seed-info">Seed: auto</div>
          <div class="chip"><button id="btn-clear" class="btn btn-ghost" style="padding:6px 10px">Effacer sauvegarde</button></div>
          <!-- Le bloc r√©sultat a √©t√© d√©plac√© dans l'onglet Quiz -->
        </div>
      </aside>
    </section>
  </div>

  <script defer src="questions.js"></script>
  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const BRAND = 'Auto √âcole Nounours';
    document.title = `${BRAND} ‚Äì Entra√Ænement Permis Moto`;
    const formatTime = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(Math.floor(s%60)).padStart(2,'0')}`;

    // petit utilitaire s√ªr pour modifier display sans optional chaining en lvalue
    const setDisplay = (sel, val) => { const el = $(sel); if (el) el.style.display = val; };

    function sample(arr, n, seed){
      const a = arr.slice(); let rand = Math.random;
      if(seed !== undefined){ let st = seed>>>0; rand = () => (st = (1664525*st + 1013904223)>>>0) / 2**32; }
      for(let i=a.length-1;i>0;i--){ const j = Math.floor(rand()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
      return a.slice(0,n);
    }
    const shuffle = (arr, seed) => sample(arr, arr.length, seed);

    const STATE = {
      series: [],
      answerOrders: [],
      answers: {},
      checked: {},
      current: 0,
      startTime: null,
      timer: null,
      seed: null,
      count: 40,
      filters:{themes:new Set(), levels:new Set()},
      mode: 'training' // 'training' | 'exam'
    };
    const STORAGE_KEY = 'quiz-moto-state-v3';
    const TAB_KEY = 'quiz-moto-tab';

    function detectTheme(){ const saved = localStorage.getItem('theme'); if(saved){ document.documentElement.setAttribute('data-theme', saved); return; } const prefersLight = window.matchMedia('(prefers-color-scheme: light)').matches; document.documentElement.setAttribute('data-theme', prefersLight? 'light':'dark'); }
    function toggleTheme(){ const cur = document.documentElement.getAttribute('data-theme'); const next = cur==='light'?'dark':'light'; document.documentElement.setAttribute('data-theme', next); localStorage.setItem('theme', next); }

    function unique(arr){ return Array.from(new Set(arr)); }
    function buildFilters(){
      if(!Array.isArray(window.BANK)) return;
      const themes = unique(BANK.map(q=>q.theme)).sort();
      const levels = unique(BANK.map(q=>q.level)).sort();
      const thWrap = $('#themes'); thWrap.innerHTML='';
      themes.forEach(t=>{
        const id=`th_${t}`; const l=document.createElement('label'); l.className='chip';
        l.innerHTML=`<input type="checkbox" id="${id}" data-type="theme" value="${t}" style="margin-right:6px"> ${t}`;
        thWrap.appendChild(l);
      });
      const lvWrap = $('#levels'); lvWrap.innerHTML='';
      levels.forEach(lv=>{
        const id=`lv_${lv}`; const l=document.createElement('label'); l.className='chip';
        l.innerHTML=`<input type="checkbox" id="${id}" data-type="level" value="${lv}" style="margin-right:6px"> ${lv}`;
        lvWrap.appendChild(l);
      });
      $$('#themes input, #levels input').forEach(inp=>{ inp.addEventListener('change', onFilterChange, {passive:true}); });
      updateFilteredPoolInfo();
    }

    function getFilteredPool(){
      const tSel = STATE.filters.themes; const lSel = STATE.filters.levels;
      return BANK.filter(q => (tSel.size? tSel.has(q.theme):true) && (lSel.size? lSel.has(q.level):true));
    }
    function updateFilteredPoolInfo(){
      const pool = getFilteredPool(); const tag=$('#filtered-size');
      if(tag) tag.textContent = `Pool filtr√©: ${pool.length}`;
    }
    function onFilterChange(e){
      const el=e.target; const val=el.value; const type=el.dataset.type;
      const set= type==='theme'? STATE.filters.themes : STATE.filters.levels;
      el.checked ? set.add(val) : set.delete(val);
      updateFilteredPoolInfo(); saveState();
    }

    function newSeries(withSeed){
      if(!Array.isArray(window.BANK) || BANK.length===0){
        alert('La banque de questions (BANK) est introuvable ou vide. V√©rifie questions.js');
        return;
      }
      const pool = getFilteredPool();
      STATE.seed = withSeed ?? Math.floor(Math.random()*2**31);
      STATE.count = Math.min(Number($('#count')?.value||40), pool.length || BANK.length);
      const chosenFrom = pool.length? pool : BANK;
      const series = sample(chosenFrom, STATE.count, STATE.seed).map((q,i)=>({q, idx:i}));
      STATE.series = series;
      STATE.answerOrders = series.map((item, i) => {
        const ids = item.q.answers.map((_, j) => j);
        const s = (STATE.seed ^ ((i + 1) * 2654435761)) >>> 0;
        return shuffle(ids, s);
      });
      STATE.answers = {};
      STATE.checked = {};
      STATE.current = 0;
      STATE.startTime = Date.now();
      if(STATE.timer) clearInterval(STATE.timer);
      STATE.timer = setInterval(updateTimer, 1000);
    
      $('#seed-info').textContent = `Seed: ${STATE.seed}`;
      $('#pool-size').textContent = `Banque de questions: ${BANK.length}`;
    
      // Sous-titre selon mode
      if (STATE.mode === 'exam') {
        $('#subtitle').textContent = `${BRAND} ¬∑ Examen blanc ¬∑ 40 questions`;
      } else {
        $('#subtitle').textContent = `${BRAND} ¬∑ S√©rie g√©n√©r√©e al√©atoirement ¬∑ ${STATE.count} question${STATE.count>1?'s':''}`;
      }
    
      // Cacher la carte r√©sultat
      setDisplay('#card-result','none');
      setDisplay('#result','none');
      setDisplay('#review','none');
    
      // Ajuster UI selon mode
      if (STATE.mode === 'exam') {
        setDisplay('#btn-check','none');
        setDisplay('#exp-wrap','none');
        setDisplay('#exam-hint','inline-block');
        setDisplay('#btn-exit-exam','inline-flex');
      } else {
        setDisplay('#btn-check','inline-flex');
        setDisplay('#exam-hint','none');
        setDisplay('#btn-exit-exam','none');
      }
    
      renderCurrent();
      updateProgress();
      updateFilteredPoolInfo();
      saveState();
    }


    function updateTimer(){
      const secs = Math.floor((Date.now()-STATE.startTime)/1000);
      $('#timer').textContent = `Temps: ${formatTime(secs)}`;
    }

function renderCurrent(){
  const { current, series } = STATE;
  const item = series[current];
  if(!item) return;

  $('#q-index').textContent = `Question ${current+1}/${series.length}`;
  $('#q-text').textContent = item.q.question;
  $('#q-meta').textContent = `Th√®me: ${item.q.theme} ¬∑ Niveau: ${item.q.level}${item.q.multi?' ¬∑ MULTI':''}`;

  const wrap = $('#answers');
  wrap.innerHTML='';
  const frag=document.createDocumentFragment();
  const indices=item.q.answers.map((_,i)=>i);
  const order = $('#toggle-shuffle-answers')?.checked ? (STATE.answerOrders[current] || indices) : indices;

  order.forEach((ansIdx)=>{
    const label=document.createElement('label');
    label.className='answer';
    label.tabIndex=0;
    const input=document.createElement('input');
    input.type = item.q.multi ? 'checkbox' : 'radio';
    input.name = `q_${current}`;
    input.value = ansIdx;
    input.checked = (STATE.answers[current] || new Set()).has(ansIdx);
    input.addEventListener('change', ()=>toggleAnswer(current, ansIdx, item.q.multi), {passive:true});
    const span=document.createElement('span');
    span.textContent = item.q.answers[ansIdx];
    label.appendChild(input);
    label.appendChild(span);
    frag.appendChild(label);
  });
  wrap.appendChild(frag);

  // Explications masqu√©es par d√©faut
  setDisplay('#exp-wrap','none');
  $('#explanation').textContent = item.q.explanation || '';

  // Boutons nav : "Pr√©c√©dent" actif sauf √† la premi√®re question
  $('#btn-prev').disabled = current===0;

  // Pas de correction automatique en mode examen
  if (STATE.mode !== 'exam' && $('#toggle-instant')?.checked && STATE.answers[current] && STATE.answers[current].size>0){
    checkCurrent(false);
  }

  // >>> (NOUVEAU) Bloquer "Suivant" et "V√©rifier" tant qu'il n'y a pas de r√©ponse
  const answered = !!(STATE.answers[current] && STATE.answers[current].size > 0);

  // "Suivant" actif seulement si une r√©ponse est donn√©e et qu'on n'est pas √† la derni√®re question
  $('#btn-next').disabled = (!answered) || (current === series.length - 1);

  // "V√©rifier" actif seulement si une r√©ponse est donn√©e (et jamais en mode examen)
  if ($('#btn-check')) {
    $('#btn-check').disabled = (!answered) || (STATE.mode === 'exam');
  }
  // <<< FIN NOUVEAU

  saveState();
}



function toggleAnswer(qIdx, ansIdx, multi){
  if(!STATE.answers[qIdx]) STATE.answers[qIdx] = new Set();
  const set = STATE.answers[qIdx];

  if(multi){
    set.has(ansIdx) ? set.delete(ansIdx) : set.add(ansIdx);
  } else {
    set.clear();
    set.add(ansIdx);
  }

  // Pas de correction auto en mode examen
  if ($('#toggle-instant')?.checked && STATE.mode !== 'exam') {
    checkCurrent(false);
  }

  // >>> (NOUVEAU) Mettre √† jour les √©tats des boutons en direct
  const hasAns = !!(STATE.answers[qIdx] && STATE.answers[qIdx].size > 0);

  if ($('#btn-next')) {
    const isLast = qIdx === (STATE.series.length - 1);
    $('#btn-next').disabled = (!hasAns) || isLast;
  }

  if ($('#btn-check')) {
    $('#btn-check').disabled = (!hasAns) || (STATE.mode === 'exam');
  }
  // <<< FIN NOUVEAU

  updateProgress();
  saveState();
}



    function isCorrect(q, chosen){
      if(q.multi){
        const corr = new Set(q.correct);
        if(chosen.size !== corr.size) return false;
        for(const c of chosen){ if(!corr.has(Number(c))) return false; }
        return true;
      }
      const [c] = Array.from(chosen);
      return Number(c) === Number(q.correct);
    }

    function checkCurrent(showAlert=true){
      // En examen : on ne montre rien question par question
      if (STATE.mode === 'exam') return;
    
      const { current, series } = STATE;
      const item = series[current];
      const chosen = STATE.answers[current] || new Set();
    
      if(chosen.size===0){
        if(showAlert) alert('Choisissez au moins une proposition.');
        return;
      }
    
      const ok = isCorrect(item.q, chosen);
      STATE.checked[current] = ok;
    
      $$('#answers .answer').forEach(el=>{ el.classList.remove('is-correct','is-wrong'); });
    
      const right = item.q.multi ? new Set(item.q.correct) : new Set([item.q.correct]);
      $$('#answers .answer').forEach(el=>{
        const val = Number(el.querySelector('input').value);
        const chosenNow = (STATE.answers[current]||new Set()).has(val);
        if(right.has(val)) el.classList.add('is-correct');
        else if(chosenNow) el.classList.add('is-wrong');
      });
    
      if($('#toggle-explanations')?.checked) setDisplay('#exp-wrap','block');
    
      $('#btn-next').animate([{transform:'scale(1)'},{transform:'scale(1.03)'},{transform:'scale(1)'}], {duration:220, easing:'ease-out'});
    
      updateProgress();
      saveState();
    }


    function updateProgress(){
      const total = STATE.series.length;
      const answered = Object.values(STATE.answers).filter(s=>s && s.size>0).length;
      const correct = Object.entries(STATE.checked).filter(([_,ok])=>ok===true).length;
      const wrong = Object.entries(STATE.checked).filter(([_,ok])=>ok===false).length;
    
      if (STATE.mode === 'exam') {
        $('#status').textContent = `${answered}/${total} r√©pondues ¬∑ ${total-answered} restantes`;
      } else {
        $('#status').textContent = `${correct} correct ¬∑ ${wrong} faux ¬∑ ${total-answered} restants`;
      }
    
      $('#progress').style.width = `${(answered/total)*100}%`;
    
      if(answered===total){
        if (STATE.mode === 'exam') {
          computeExamResults();
        }
        showResults();
      }
    }

function enterExamMode() {
  STATE.mode = 'exam';
  // imposer 40 questions, pas d‚Äôexplications ni correction auto
  if ($('#toggle-instant')) $('#toggle-instant').checked = false;
  if ($('#toggle-explanations')) $('#toggle-explanations').checked = false;
  if ($('#count')) $('#count').value = 40;

  newSeries();
  $('#subtitle').textContent = `${BRAND} ¬∑ Examen blanc ¬∑ 40 questions`;
  setDisplay('#btn-check','none');
  setDisplay('#exp-wrap','none');
  setDisplay('#exam-hint','inline-block');
  setDisplay('#btn-exit-exam','inline-flex');
}

function exitExamMode() {
  STATE.mode = 'training';
  $('#subtitle').textContent = `${BRAND} ¬∑ S√©rie g√©n√©r√©e al√©atoirement ¬∑ ${STATE.count} question${STATE.count>1?'s':''}`;
  setDisplay('#btn-check','inline-flex');
  setDisplay('#exam-hint','none');
  setDisplay('#btn-exit-exam','none');
}

function computeExamResults(){
  STATE.checked = {};
  STATE.series.forEach((item,i)=>{
    const chosen = STATE.answers[i] || new Set();
    STATE.checked[i] = isCorrect(item.q, chosen);
  });
}

    function showResults(){
      const total = STATE.series.length;
      const correct = Object.entries(STATE.checked).filter(([_,ok])=>ok===true).length;

      const scoreEl = $('#score');
      scoreEl.textContent = `${correct} / ${total}`;
      scoreEl.classList.remove('good','mid','bad');
      const ratio = correct/total;
      if(ratio>=.8) scoreEl.classList.add('good');
      else if(ratio>=.5) scoreEl.classList.add('mid');
      else scoreEl.classList.add('bad');

      $('#score-note').textContent = ratio>=.8 ? 'Excellent !' : ratio>=.5 ? 'Bien, encore un petit effort.' : 'Continuez : r√©visez vos th√®mes faibles.';

      // afficher la carte r√©sultat dans le panel Quiz
      setTab('quiz');
      setDisplay('#card-result','block');
      setDisplay('#result','grid');

      const wrap = $('#review'); wrap.innerHTML='';
      STATE.series.forEach((item,i)=>{
        const div = document.createElement('div'); const ok = STATE.checked[i]===true;
        div.className='review-item';
        div.innerHTML = `<div class="status ${ok?'ok':'ko'}">${ok?'‚úî Correct':'‚úñ Faux'} ‚Äî Q${i+1} (${item.q.theme})</div>
          <div style="font-weight:700; margin-top:4px">${item.q.question}</div>
          <ul style="margin:8px 0 0 18px; padding:0">
            ${item.q.answers.map((a,j)=>`<li${(item.q.multi?item.q.correct.includes(j):j===item.q.correct)?' style="font-weight:700"':''}>${a}</li>`).join('')}
          </ul>
          ${item.q.explanation?`<div class="explanation" style="margin-top:8px">${item.q.explanation}</div>`:''}`;
        wrap.appendChild(div);
      });
      setDisplay('#review','grid');

      document.querySelector('#card-result').scrollIntoView({behavior:'smooth'});
      saveState();
    }

    function serializeState(){
      return JSON.stringify({
        STATE: { ...STATE, answers: Object.fromEntries(Object.entries(STATE.answers).map(([k,v])=>[k, Array.from(v||[])])) },
        toggles:{ instant: $('#toggle-instant')?.checked, expl: $('#toggle-explanations')?.checked, shuffle: $('#toggle-shuffle-answers')?.checked },
        count: Number($('#count')?.value||40)
      });
    }
    function saveState(){ try{ localStorage.setItem(STORAGE_KEY, serializeState()); }catch(e){} }
    function restoreState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return false;
        const data = JSON.parse(raw); if(!data || !data.STATE) return false;
        Object.assign(STATE, data.STATE);
        Object.keys(STATE.answers).forEach(k=>{ STATE.answers[k] = new Set(STATE.answers[k]); });
        if($('#toggle-instant')) $('#toggle-instant').checked = !!data.toggles?.instant;
        if($('#toggle-explanations')) $('#toggle-explanations').checked = data.toggles?.expl!==false;
        if($('#toggle-shuffle-answers')) $('#toggle-shuffle-answers').checked = data.toggles?.shuffle!==false;
        if($('#count')) $('#count').value = data.count || 40;
        return true;
      }catch(e){ return false; }
    }

    function setTab(tab){
      const isQuiz = tab==='quiz';
      const quizPanel=$('#panel-quiz'); const setPanel=$('#panel-settings');
      quizPanel.hidden = !isQuiz; setPanel.hidden = isQuiz;
      $('#tabbtn-quiz').setAttribute('aria-selected', isQuiz? 'true':'false');
      $('#tabbtn-settings').setAttribute('aria-selected', !isQuiz? 'true':'false');
      localStorage.setItem(TAB_KEY, tab);
    }

    // Actions
    $('#btn-start-exam')?.addEventListener('click', ()=>{
      enterExamMode();
      setTab('quiz');
      window.scrollTo({top:0, behavior:'smooth'});
    }, {passive:true});

    $('#btn-exit-exam')?.addEventListener('click', ()=>{
      if (confirm('Quitter le mode examen ? Les corrections par question seront r√©activ√©es.')) {
        exitExamMode();
        renderCurrent();
        updateProgress();
      }
    }, {passive:true});

    $('#btn-prev').addEventListener('click', ()=>{ STATE.current = Math.max(0, STATE.current-1); renderCurrent(); }, {passive:true});
    $('#btn-next').addEventListener('click', ()=>{ STATE.current = Math.min(STATE.series.length-1, STATE.current+1); renderCurrent(); }, {passive:true});
    $('#btn-check').addEventListener('click', ()=>checkCurrent(), {passive:true});
    $('#btn-new').addEventListener('click', ()=>newSeries(), {passive:true});
    $('#btn-reset').addEventListener('click', ()=>{ if(confirm('R√©initialiser la s√©rie en cours ?')) newSeries(STATE.seed); }, {passive:true});

    // Revoir : rester dans l‚Äôonglet Quiz
    $('#btn-review').addEventListener('click', ()=>{
      setTab('quiz'); setDisplay('#review','grid');
      document.querySelector('#review').scrollIntoView({behavior:'smooth'});
    }, {passive:true});

    // Rejouer les erreurs
    $('#btn-retry-wrong').addEventListener('click', ()=>{
      const wrongIdx = Object.entries(STATE.checked).filter(([_,ok])=>ok===false).map(([i])=>Number(i));
      if(wrongIdx.length===0){ alert('Aucune erreur √† rejouer.'); return; }
      const wrongQs = wrongIdx.map(i=>STATE.series[i].q);
      const needed = Math.max(0, STATE.count - wrongQs.length);
      const extra = sample(BANK.filter(q=>!wrongQs.includes(q)), needed, (STATE.seed+999)>>>0);
      STATE.seed = (STATE.seed+12345)>>>0;
      STATE.series = [...wrongQs,...extra].map((q,i)=>({q,idx:i}));
      STATE.answers={}; STATE.checked={}; STATE.current=0; STATE.startTime=Date.now();
      setTab('quiz'); renderCurrent(); updateProgress();
      window.scrollTo({top:0,behavior:'smooth'}); saveState();
    }, {passive:true});

    // Param√®tres
    $('#toggle-instant')?.addEventListener('change', ()=>{ renderCurrent(); saveState(); }, {passive:true});
    $('#toggle-explanations')?.addEventListener('change', ()=>{ if(!$('#toggle-explanations').checked) setDisplay('#exp-wrap','none'); saveState(); }, {passive:true});
    $('#toggle-shuffle-answers')?.addEventListener('change', ()=>{ renderCurrent(); saveState(); }, {passive:true});
    $('#btn-apply-filters')?.addEventListener('click', ()=>{ newSeries(); setTab('quiz'); }, {passive:true});
    $('#count')?.addEventListener('change', ()=>{ if($('#count').value<1) $('#count').value = 1; updateFilteredPoolInfo(); saveState(); });
    $('#btn-clear')?.addEventListener('click', ()=>{ localStorage.removeItem(STORAGE_KEY); alert('Sauvegarde effac√©e.'); }, {passive:true});
    $('#btn-theme').addEventListener('click', toggleTheme);

    // Tab buttons
    $('#tabbtn-quiz').addEventListener('click', ()=>setTab('quiz'));
    $('#tabbtn-settings').addEventListener('click', ()=>setTab('settings'));

    window.addEventListener('DOMContentLoaded', ()=>{
      const prefersLight = window.matchMedia('(prefers-color-scheme: light)');
      prefersLight.addEventListener?.('change', detectTheme); // optionnel
      detectTheme();
      if(!Array.isArray(window.BANK) || !BANK.length){ console.warn('BANK indisponible.'); return; }
      buildFilters();
      const restored = restoreState();
      const savedTab = localStorage.getItem(TAB_KEY) || 'quiz';
      setTab(savedTab);
      if(restored && STATE.series.length){ renderCurrent(); updateProgress(); updateFilteredPoolInfo(); }
      else { newSeries(); }
    });
  </script>
</body>
</html>
